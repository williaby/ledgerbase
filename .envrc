# 1) Direnv bootstrap
eval "$(direnv hook bash)"

# 2) Decrypt & export Azure SP creds in dotenv form
SOPS_FILE="${PWD}/.envrc.values.sops.yaml"
if [ -f "$SOPS_FILE" ]; then
  TMPFILE="$(mktemp)"
  sops \
    --decrypt \
    --input-type dotenv \
    --output-type dotenv \
    "$SOPS_FILE" > "$TMPFILE"
  source "$TMPFILE"
  rm -f "$TMPFILE"

  export AZURE_CLIENT_ID \
         AZURE_TENANT_ID \
         AZURE_CLIENT_SECRET \
         AZURE_SUBSCRIPTION_ID
else
  echo "⚠️  Missing encrypted creds: $SOPS_FILE" >&2
fi

# 3) Set Key Vault prefix
export LEDGERBASE_ENV="${LEDGERBASE_ENV:-dev}"

# 4) Cleanup stray plain .env files
rm -f ledgerbase_secure_env/.env.dev ledgerbase_secure_env/.env.prod
