name: Run Lint Session Matrix

on:
  workflow_call:
    inputs:
      sessions:
        required: true
        type: string
      python-version:
        required: false
        type: string
        default: "3.11"

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      python-version: ${{ steps.extract.outputs.versions }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load Python versions from python-versions.json
        if: inputs.python-version == '3.11'
        id: extract
        run: |
          versions=$(jq -c .python_versions .github/workflows/templates/python-versions.json)
          echo "versions=$versions" >> $GITHUB_OUTPUT

  run-default:
    needs: setup
    if: inputs.python-version == '3.11'
    strategy:
      matrix:
        session: ${{ fromJson(inputs.sessions) }}
        python-version: ${{ fromJson(needs.setup.outputs.python-version) }}
    runs-on: ubuntu-22.04
    name: Run ${{ matrix.session }} [Py ${{ matrix.python-version }}]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Nox
        run: python -m pip install --upgrade nox
      - name: Run Nox session
        run: |
          nox -s ${{ matrix.session }}

  run-override:
    if: inputs.python-version != '3.11'
    strategy:
      matrix:
        session: ${{ fromJson(inputs.sessions) }}
        python-version: ${{ fromJson(inputs.python-version) }}
    runs-on: ubuntu-22.04
    name: Run ${{ matrix.session }} [Py ${{ matrix.python-version }}]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Nox
        run: python -m pip install --upgrade nox
      - name: Run Nox session
        run: |
          nox -s ${{ matrix.session }}
