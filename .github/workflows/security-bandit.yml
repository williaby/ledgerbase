name: Security - Bandit Scan

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: '0 3 * * *'

jobs:
  bandit-scan:
    name: Python Security Scan (Bandit)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write           # Needed for labeling
      security-events: write         # Needed for SARIF upload

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit with SARIF output
        run: |
          bandit -r . -ll -f sarif -o bandit-results.sarif || true

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: bandit-results.sarif

      - name: Auto-label PR if Bandit finds issues
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const sarif = JSON.parse(fs.readFileSync('bandit-results.sarif', 'utf8'));
            const results = sarif.runs?.[0]?.results || [];
            if (results.length > 0) {
              const label = "security:bandit";
              const pr = context.payload.pull_request;
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [label],
              });
            }
