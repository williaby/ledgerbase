name: Security - Snyk

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]
    schedule:
        -   cron: '0 3 * * *'

permissions:
    contents: read
    pull-requests: write

jobs:
    snyk:
        name: Snyk Scan
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v4

            -   name: Set up Python
                uses: actions/setup-python@v5
                with:
                    python-version: '3.11'

            -   name: Install dependencies
                run: |
                    poetry install --no-interaction --no-root


            -   name: Run Snyk to check for vulnerabilities
                uses: snyk/actions/python@0.3.0
                env:
                    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
                with:
                    args: test --all-projects --json-file-output=snyk-results.json
                continue-on-error: true

            -   name: Upload Snyk JSON report
                uses: actions/upload-artifact@v3
                with:
                    name: snyk-report
                    path: snyk-results.json

            -   name: Add snyk-failed label on failure
                if: failure()
                uses: actions/github-script@v7
                with:
                    script: |
                        const label = 'snyk-failed';
                        const issue_number = context.payload.pull_request?.number;
                        if (issue_number) {
                          const labels = await github.rest.issues.listLabelsOnIssue({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number
                          });
                          const hasLabel = labels.data.some(l => l.name === label);
                          if (!hasLabel) {
                            await github.rest.issues.addLabels({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number,
                              labels: [label]
                            });
                          }
                        }

            -   name: Remove snyk-failed label on success
                if: success()
                uses: actions/github-script@v7
                with:
                    script: |
                        const label = 'snyk-failed';
                        const issue_number = context.payload.pull_request?.number;
                        if (issue_number) {
                          try {
                            await github.rest.issues.removeLabel({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number,
                              name: label
                            });
                          } catch (e) {
                            if (e.status !== 404) throw e;
                          }
                        }
