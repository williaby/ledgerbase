name: Semgrep

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]
    schedule:
        -   cron: '0 3 * * *'

permissions:
    contents: read
    pull-requests: write

jobs:
    semgrep:
        name: Semgrep Code Scan
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v4

            -   name: Install Semgrep
                run: pip install semgrep

            -   name: Run Semgrep with custom rules and output to JSON
                run: semgrep --config=semgrep.yml --error --json > semgrep-results.json

            -   name: Upload Semgrep Report
                uses: actions/upload-artifact@v3
                with:
                    name: semgrep-report
                    path: semgrep-results.json

            -   name: Add semgrep label on failure
                if: failure()
                uses: actions/github-script@v7
                with:
                    script: |
                        const label = 'semgrep-failed';
                        const issue_number = context.payload.pull_request?.number;
                        if (issue_number) {
                          const labels = await github.rest.issues.listLabelsOnIssue({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number
                          });
                          const hasLabel = labels.data.some(l => l.name === label);
                          if (!hasLabel) {
                            await github.rest.issues.addLabels({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number,
                              labels: [label]
                            });
                          }
                        }

            -   name: Remove semgrep label on success
                if: success()
                uses: actions/github-script@v7
                with:
                    script: |
                        const label = 'semgrep-failed';
                        const issue_number = context.payload.pull_request?.number;
                        if (issue_number) {
                          try {
                            await github.rest.issues.removeLabel({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number,
                              name: label
                            });
                          } catch (e) {
                            if (e.status !== 404) throw e;
                          }
                        }
